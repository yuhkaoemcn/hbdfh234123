name: Run Private park.sh (quiet, masked, 50 runners)
on:
  workflow_dispatch:
    inputs:
      url:
        description: "Target URL (https://...)"
        required: true
      countries:
        description: "EU,AM,... (15 adet; boşsa default)"
        required: false
        default: "EU,AM,EU,AM,EU,AM,EU,AM,EU,AM,EU,AM,EU,AM,EU"
      headless_mode:
        description: "Headless mode (true/false)"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 400  # Biraz artırdım çünkü setup süreci daha uzun
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        runner_index: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9,
                       10, 11, 12, 13, 14, 15, 16, 17, 18, 19,
                       20, 21, 22, 23, 24, 25, 26, 27, 28, 29,
                       30, 31, 32, 33, 34, 35, 36, 37, 38, 39,
                       40, 41, 42, 43, 44, 45, 46, 47, 48, 49]
    steps:
      - name: Mask inputs in logs
        run: |
          echo "::add-mask::${{ inputs.url }}"
          echo "::add-mask::${{ inputs.countries }}"
          echo "::add-mask::TARGET_URL=${{ inputs.url }}"
          echo "::add-mask::COUNTRIES=${{ inputs.countries }}"
          
      - name: Checkout private repo (read-only)
        uses: actions/checkout@v4
        with:
          repository: aynibakbabm/private-repo
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: .priv
          persist-credentials: false
          
      - name: Enhanced system setup
        run: |
          set -e
          # System updates with fixes
          sudo apt-get update -y
          sudo apt-get install -y curl wget gnupg2 software-properties-common
          
          # Fix broken packages first
          sudo apt-get install -f -y || true
          sudo dpkg --configure -a || true
          
          # Docker sanity check
          docker --version
          
          # Install Chrome dependencies with fixed approach
          sudo apt-get install -y --fix-missing --no-install-recommends \
            libnss3 \
            libatk-bridge2.0-0 \
            libdrm2 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            libgbm1 \
            libxss1 \
            libatspi2.0-0 \
            libgtk-3-0 \
            libgdk-pixbuf2.0-0 \
            libxfixes3 \
            libxinerama1 \
            libpangocairo-1.0-0 \
            libcairo-gobject2 \
            fonts-liberation \
            libappindicator3-1 \
            xdg-utils
            
          # Try to install libasound2 separately (the problematic one)
          sudo apt-get install -y libasound2 || {
            echo "libasound2 installation failed, trying alternative approach..."
            sudo apt-get install -y --fix-broken || true
            sudo apt-get install -y alsa-base alsa-utils || true
          }
          
          # Set Chrome/Chromium environment for headless
          export CHROME_BIN=/usr/bin/google-chrome-stable
          export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=false
          export PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome-stable
          
          # Chrome memory ve resource limits
          echo 'vm.max_map_count=262144' | sudo tee -a /etc/sysctl.conf
          sudo sysctl -p || true
          
      - name: Setup Node.js 20 with enhanced config
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          # Remove cache to avoid lock file issues
          
      - name: Pre-install Node dependencies with fallbacks
        run: |
          set -e
          
          # Clear all npm caches and configs
          npm cache clean --force || true
          rm -rf ~/.npm || true
          rm -rf /home/runner/.npm || true
          rm -rf node_modules package-lock.json yarn.lock || true
          
          # Set npm to ignore lockfiles and use latest versions
          npm config set package-lock false
          npm config set shrinkwrap false
          npm config set fund false
          npm config set audit false
          
          # Create clean working directory
          mkdir -p /tmp/puppeteer-setup
          cd /tmp/puppeteer-setup
          
          # Initialize fresh package.json
          echo '{"name":"puppeteer-setup","version":"1.0.0","main":"index.js"}' > package.json
          
          # Install dependencies one by one with specific versions
          echo "Installing puppeteer..."
          npm install puppeteer@21.6.1 --no-package-lock --no-shrinkwrap --no-save || {
            echo "Puppeteer install failed, trying older version..."
            npm install puppeteer@19.11.1 --no-package-lock --no-shrinkwrap --no-save || {
              echo "Still failed, trying without version constraint..."
              npm install puppeteer --no-package-lock --no-shrinkwrap --no-save
            }
          }
          
          # Try puppeteer-extra (optional)
          echo "Installing puppeteer-extra..."
          npm install puppeteer-extra --no-package-lock --no-shrinkwrap --no-save || {
            echo "puppeteer-extra failed, will use basic puppeteer"
          }
          
          # Try stealth plugin (optional)
          echo "Installing stealth plugin..."
          npm install puppeteer-extra-plugin-stealth --no-package-lock --no-shrinkwrap --no-save || {
            echo "stealth plugin failed, will use basic puppeteer"
          }
          
          # Set NODE_PATH for global access
          echo "NODE_PATH=/tmp/puppeteer-setup/node_modules:$NODE_PATH" >> $GITHUB_ENV
          echo "PUPPETEER_SETUP_DIR=/tmp/puppeteer-setup" >> $GITHUB_ENV
          
          # Try Puppeteer Chrome download with multiple approaches
          echo "Setting up Chrome for Puppeteer..."
          cd /tmp/puppeteer-setup
          node -e "
            try {
              const puppeteer = require('puppeteer');
              console.log('Puppeteer loaded successfully');
            } catch(e) {
              console.log('Puppeteer load failed:', e.message);
              process.exit(1);
            }
          " || {
            echo "Puppeteer test failed, trying manual Chrome installation..."
            
            # Manual Chrome installation
            wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add - || true
            echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list || true
            sudo apt-get update -y || true
            sudo apt-get install -y google-chrome-stable || true
            
            # Set Chrome path
            echo "PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome-stable" >> $GITHUB_ENV
          }
          
      - name: Setup virtual display for headless Chrome
        run: |
          # Xvfb kurulumu (headless display) with error handling
          sudo apt-get install -y xvfb || {
            echo "Xvfb installation failed, trying alternative..."
            sudo apt-get install -y xserver-xorg-video-dummy || true
          }
          
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 -nolisten tcp -dpi 96 > /dev/null 2>&1 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          
          # Wait for Xvfb to start
          sleep 3
          
          # Test display
          echo "Testing display..."
          DISPLAY=:99 xdpyinfo || echo "Display test failed but continuing..."
          
      - name: Docker resource optimization
        run: |
          # Docker için sistem optimizasyonu
          echo '{"log-level": "warn", "storage-driver": "overlay2"}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker
          
          # Memory limits
          echo 'DefaultLimitNOFILE=65536' | sudo tee -a /etc/systemd/system.conf
          
      - name: Run enhanced park.sh quietly (masked)
        env:
          TARGET_URL: ${{ inputs.url }}
          COUNTRIES: ${{ inputs.countries }}
          RUNNER_INDEX: ${{ matrix.runner_index }}
          HEADLESS_MODE: ${{ inputs.headless_mode }}
          DISPLAY: :99
          # Chrome optimization flags
          CHROME_FLAGS: "--no-sandbox --disable-setuid-sandbox --disable-dev-shm-usage --disable-gpu --remote-debugging-port=9222"
          # Puppeteer optimizations
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "false"
          PUPPETEER_EXECUTABLE_PATH: "/usr/bin/google-chrome-stable"
          # Memory management
          NODE_OPTIONS: "--max-old-space-size=4096"
        shell: bash
        run: |
          set -e
          
          # Permissions
          chmod +x .priv/park.sh || true
          
          # Resource monitoring background process
          (
            while true; do
              echo "[$(date)] Memory: $(free -h | grep ^Mem | awk '{print $3"/"$2}')"
              echo "[$(date)] Docker: $(docker ps --format 'table {{.Names}}\t{{.Status}}' 2>/dev/null | wc -l) containers"
              sleep 300  # Her 5 dakika
            done
          ) &
          monitor_pid=$!
          
          # Ana script'i çalıştır
          ( set +x; timeout 6h .priv/park.sh > run.log 2>&1 ) &
          main_pid=$!
          
          # Progress indicator
          while kill -0 "$main_pid" 2>/dev/null; do
            echo "[$(date)] runner-${RUNNER_INDEX} active... (PID: $main_pid)"
            sleep 300
          done
          
          # Cleanup monitor
          kill "$monitor_pid" 2>/dev/null || true
          
          # Wait for main process
          wait "$main_pid" || {
            echo "----- RUNNER ${RUNNER_INDEX} ERROR LOG (SANITIZED) -----"
            tail -n 300 run.log \
              | sed -E 's#https?://[^[:space:]]+#[REDACTED_URL]#g' \
              | sed -E 's/([0-9]{1,3}\.){3}[0-9]{1,3}/[REDACTED_IP]/g' \
              | sed -E 's/'"$COUNTRIES"'/[REDACTED_COUNTRIES]/g' \
              | grep -E "(Error|Failed|Exception|Timeout)" || echo "No specific errors found"
            exit 1
          }
          
      - name: Resource cleanup and monitoring
        if: always()
        run: |
          # Container cleanup
          docker ps -aq | head -20 | xargs -r docker rm -f || true
          
          # Process cleanup
          pkill -f "chrome|chromium|node" || true
          pkill -f "Xvfb" || true
          
          # Disk cleanup
          docker system prune -f || true
          sudo apt-get clean || true
          
          # Log cleanup
          shred -u run.log || rm -f run.log || true
          
          # Final resource report
          echo "Final system state:"
          echo "Memory: $(free -h | grep ^Mem)"
          echo "Disk: $(df -h /)"
          echo "Processes: $(ps aux | wc -l)"
